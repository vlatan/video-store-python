{% extends "layout.html" %}
{% block css %}
<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='home.css') }}">
{% endblock css %}

{% block title %}
<title>Doxder</title>
{% endblock title %}

{% block content %}

<!-- div to contain the content -->
<div id="scroller" class="home-content">

	{% for post in posts %}

	<a class="home-video-link" href="{{ url_for('posts.post', post_id=post.id) }}">
		<img class="home-video-img" src="{{ post.thumbnails['medium']['url'] }}"
			width="{{ post.thumbnails['medium']['width'] }}" height="{{ post.thumbnails['medium']['height'] }}"
			alt="{{ post.provider_title }}">
		<h2 class="home-video-title">{{ post.title }}</h2>
	</a>

	{% endfor %}

	<template id="post_template" data-value="{{ quantity }}">
		<!-- template content -->
		<a class="home-video-link" href="#">
			<img class="home-video-img" src="#">
			<h2 class="home-video-title"></h2>
		</a>
	</template>

</div>

<!-- element to trigger the IntersectionObserver -->
<div class="sentinel" id="sentinel">
	<div class="spinner-border" role="status"></div>
</div>

<script>
	// Get references to the dom elements
	var scroller = document.querySelector("#scroller");
	var template = document.querySelector('#post_template');
	var sentinel = document.querySelector('#sentinel');

	// Set a counter to count the items loaded
	var counter = parseInt(template.getAttribute('data-value'));
	// There are still posts to be fetched
	var the_end = false;

	// Function to request new items and render to the dom
	function loadItems() {

		// Use fetch to request data and pass the counter value in the QS
		fetch(`/?c=${counter}`).then((response) => {

			// Convert the response data to JSON
			response.json().then((data) => {

				// log to console if there's call to backend
				console.log('Backend called');
				console.log(`${data.length} posts fetched`);

				// If empty JSON, exit the function
				if (!data.length) {

					// Replace the spinner with "No more posts"
					sentinel.innerHTML = "No more posts";
					// We got to the end, no more posts
					the_end = true;
					// log to console if there are no more posts
					console.log('No more posts');
					return;
				}

				// Iterate over the items in the response
				for (var i = 0; i < data.length; i++) {

					// Clone the HTML template
					let template_clone = template.content.cloneNode(true);

					// Query & update the template content
					template_clone.querySelector('.home-video-link').href = `/post/${data[i]['id']}`;
					let thumb = template_clone.querySelector('.home-video-img');
					thumb.src = data[i]['thumbnails']['medium']['url'];
					thumb.alt = data[i]['provider_title'];
					template_clone.querySelector('.home-video-title').innerHTML = data[i]['provider_title'];

					// Append template to dom
					scroller.appendChild(template_clone);

					// Increment the counter
					counter += 1;
				}
			})
		})
	}

	// Create a new IntersectionObserver instance
	var intersectionObserver = new IntersectionObserver(entries => {

		// Uncomment below to see the entry.intersectionRatio when
		// the sentinel comes into view
		entries.forEach(entry => {
			console.log(entry.intersectionRatio);
		})

		// If intersectionRatio is 0, the sentinel is out of view
		// or if we reached the end of the database
		// we don't need to do anything. Exit the function
		if (entries[0].intersectionRatio <= 0 || the_end == true) {
			return;
		}

		// Call the loadItems function
		loadItems();
	});

	// Instruct the IntersectionObserver to watch the sentinel
	intersectionObserver.observe(sentinel);
</script>

{% endblock content %}